/* Insert Automático de Checklist dos Planos - Modelo Americana               */
/*----------------------------------------------------------------------------*/
SELECT  --PLAMANUT.TAG PLANODEST, PLANO.PLANOBASE 'FIL+PLANO_BASE', 
                '/*'+ PLAMANUT.TAG +'*/ INSERT INTO ENGEMAN.ENGEMAN.CHKPLANO (CODEMP,CODMOE,SERVSLA,PLAMANUT.CODPLA,PLAXSET.CODPLAXSET,PLAXSET.CODSET,CHKPLANO.ORDEM,CHKPLANO.TAGGRU,CHKPLANO.DESCRICAO) VALUES (1,1,''N'','
                +CAST(PLAMANUT.CODPLA AS VARCHAR)
                +','+CAST(PLAXSET.CODPLAXSET AS VARCHAR)
                +','+CAST(PLAXSET.CODSET AS VARCHAR)
                +','+CAST(PLANO.ORDEM AS VARCHAR)
                +','''+PLANO.TAGGRU
                +''','''+PLANO.DESCRICAO     
                +''')' 
                +CHAR(13)+'!' 
                AS '/*INSERT*/' 
 
FROM ENGEMAN.PLAMANUT
INNER JOIN FILIAL ON FILIAL.TAG=SUBSTRING(PLAMANUT.TAG,1,3)
INNER JOIN PLAXSET ON PLAXSET.CODPLA=PLAMANUT.CODPLA 
--INNER JOIN CHKPLANO ON CHKPLANO.CODPLAXSET=PLAXSET.CODPLAXSET 
INNER JOIN ( SELECT SUBSTRING(PLAMANUT.TAG,4,LEN(PLAMANUT.TAG)) TAG,PLAMANUT.TAG PLANOBASE,  PLAMANUT.CODPLA, PLAXSET.CODPLAXSET, PLAXSET.CODSET, CHKPLANO.ORDEM, CHKPLANO.TAGGRU, CHKPLANO.DESCRICAO
             FROM PLAMANUT
             INNER JOIN PLAXSET ON PLAXSET.CODPLA=PLAMANUT.CODPLA 
             INNER JOIN CHKPLANO ON CHKPLANO.CODPLAXSET=PLAXSET.CODPLAXSET AND PLAMANUT.TAG LIKE 'XXX'
            ) PLANO ON 2=2 AND FILIAL.TAG + PLANO.TAG=PLAMANUT.TAG   

WHERE PLAMANUT.TAG=FILIAL.TAG+PLANO.TAG
AND ENGEMAN.ENGEMAN.PLAMANUT.CODPLA NOT IN (SELECT CHKPLANO.CODPLA FROM ENGEMAN.ENGEMAN.CHKPLANO)
AND PLAXSET.CODPLAXSET NOT IN (SELECT CHKPLANO.CODPLAXSET FROM ENGEMAN.CHKPLANO WHERE CODPLA NOT IN (SELECT CHKPLANO.CODPLA FROM ENGEMAN.CHKPLANO))
--AND FILIAL.TAG IN ('CGR','COC','POL','MVE','NIA','SGO','VAE','VGA','ARV','PLA','AIR','GOE','SLU')
ORDER BY PLAMANUT.TAG, PLANO.TAGGRU, PLANO.ORDEM                      