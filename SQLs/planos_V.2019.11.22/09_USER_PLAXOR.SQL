/*-------------------------------------------------------------------------------------------------------------------------------*/
/*  INSERÇÃO AUTOMÁTICA DE PLANOS BASEADO NOS PLANOS BASE - USAR APENAS UM PLANO COMO BASE E PASSAR FILIAIS NO WHERE             */
/*  BEETHOVEN SANTOS NUNES                                                                                                       */
DECLARE @BASE AS VARCHAR(15), @DEST AS VARCHAR(15)
SET @BASE  = 'MAC-SE-MT-EQ-%'
SET @DEST  = '%'+SUBSTRING(@BASE, 4,LEN(@BASE))+'%'

SELECT DISTINCT --PLAMANUT.TAG PLANODEST, PLANOBASE,
                ' INSERT INTO ENGEMAN.ENGEMAN.USER_PLAXOR (R_PLAMANUT_CODPLA,U_DESC,U_SEQ) VALUES ('
                +CAST(PLAMANUT.CODPLA AS VARCHAR)
                +','''+U_DESC 
                +''','+CAST(U_SEQ AS VARCHAR)
                +')' + '--'+PLAMANUT.TAG 
               -- +CHAR(13)+'!' 
                AS '/*INSERT*/' 
 
FROM ENGEMAN.ENGEMAN.PLAMANUT
INNER JOIN ( 
 SELECT 'ABT' TAG UNION 
 SELECT 'ARD' TAG UNION 
 SELECT 'ATL' TAG UNION 
 SELECT 'BNT' TAG UNION 
 SELECT 'BSL' TAG UNION 
 SELECT 'CDV' TAG UNION 
 SELECT 'CHE' TAG UNION 
 SELECT 'FRC' TAG UNION 
 SELECT 'ICZ' TAG UNION  
 SELECT 'MPD' TAG UNION 
 SELECT 'MVD' TAG UNION 
 SELECT 'MVT' TAG UNION 
 SELECT 'PFA' TAG UNION 
 SELECT 'PRU' TAG UNION 
 SELECT 'RDV' TAG UNION 
 SELECT 'STC' TAG 
) FILIAL ON FILIAL.TAG=SUBSTRING(PLAMANUT.TAG,1,3)
INNER JOIN ( SELECT SUBSTRING(TAG,4,LEN(TAG)) TAG, R_PLAMANUT_CODPLA 'CODPLA', PLAMANUT.TAG 'PLANOBASE', U_DESC, U_SEQ
             FROM USER_PLAXOR
             INNER JOIN PLAMANUT ON PLAMANUT.CODPLA=USER_PLAXOR.R_PLAMANUT_CODPLA AND PLAMANUT.TAG LIKE @BASE --PLANO BASE
            ) PLANO ON 2=2 AND FILIAL.TAG + PLANO.TAG=PLAMANUT.TAG AND PLAMANUT.TAG LIKE @DEST --PLANO DESTINO    

WHERE SUBSTRING(PLAMANUT.TAG,4,LEN(PLAMANUT.TAG))=SUBSTRING(PLANO.PLANOBASE,4,LEN(PLANO.PLANOBASE))
--AND SUBSTRING(PLAMANUT.TAG,1,3) IN ('ABT','ARD','ATL','BNT','BSL','CDV','CHE','FRC','ICZ','MPD','MVD','MVT','PFA','PRU','RDV','STC') --FILIAIS DESTINO DO PLANO
AND ENGEMAN.ENGEMAN.PLAMANUT.CODPLA NOT IN (SELECT R_PLAMANUT_CODPLA FROM ENGEMAN.ENGEMAN.USER_PLAXOR)