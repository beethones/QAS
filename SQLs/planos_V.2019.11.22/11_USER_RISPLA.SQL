/* INSERT AUTOMATICO DE PLANOS DE MANUTENÇÃO POR FONTE-TIPO - TABELA RISCOS DO PLANO    */
/*--------------------------------------------------------------------------------------*/
DECLARE @BASE AS VARCHAR(15), @DEST AS VARCHAR(15)
SET @BASE  = 'XXXXX%'
SET @DEST  = '%'+SUBSTRING(@BASE, 4,LEN(@BASE))+'%'
 
SELECT --PLAMANUT.TAG PLANODEST, PLANOBASE,
                ' INSERT INTO ENGEMAN.ENGEMAN.USER_RISPLA (R_PLAMANUT_CODPLA, R_USER_RISLOC_U_PK_REDUZIDO) VALUES ('
                +CAST(PLAMANUT.CODPLA AS VARCHAR)
                +','+CAST(RISCO.COD AS VARCHAR)  +')' + '--'+PLAMANUT.TAG 
                +CHAR(13)+'!' 
                AS '/*INSERT*/' 
 
FROM ENGEMAN.ENGEMAN.PLAMANUT
INNER JOIN FILIAL ON FILIAL.TAG=SUBSTRING(PLAMANUT.TAG,1,3)
INNER JOIN ( SELECT SUBSTRING(TAG,4,LEN(TAG)) TAG, R_PLAMANUT_CODPLA 'CODPLA', PLAMANUT.TAG 'PLANOBASE', R_USER_RISLOC_U_PK_REDUZIDO 'COD'
             FROM USER_RISPLA
             INNER JOIN PLAMANUT ON PLAMANUT.CODPLA=USER_RISPLA.R_PLAMANUT_CODPLA AND PLAMANUT.TAG LIKE @BASE --PLANO BASE
            ) RISCO ON 2=2 AND FILIAL.TAG + RISCO.TAG=PLAMANUT.TAG AND PLAMANUT.TAG LIKE @DEST --PLANO DESTINO 

WHERE ENGEMAN.ENGEMAN.PLAMANUT.CODPLA NOT IN (SELECT R_PLAMANUT_CODPLA FROM ENGEMAN.ENGEMAN.USER_RISPLA)